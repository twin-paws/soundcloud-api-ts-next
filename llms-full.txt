# soundcloud-api-ts-next

> React hooks and Next.js API route handlers for the SoundCloud API. Client secrets stay on the server.

## What this package does
- Provides 25+ React hooks for accessing SoundCloud data (tracks, users, playlists, search)
- Provides 10 infinite scroll hooks with cursor-based pagination
- Provides secure Next.js API route handlers that keep OAuth credentials server-side
- Provides full OAuth 2.1 authentication with PKCE via `secure.soundcloud.com`
- Provides mutation hooks for authenticated actions (like, follow, repost)
- Built on soundcloud-api-ts

## When to use this package
- Building a Next.js app that needs SoundCloud data
- Building a music discovery or streaming app with React
- Need to search SoundCloud tracks, users, or playlists from a React app
- Need SoundCloud OAuth login in a Next.js app
- Need a SoundCloud audio player in React
- Want typed SoundCloud API access without exposing client secrets to the browser

## When NOT to use this package
- Not using React or Next.js (use soundcloud-api-ts directly instead)
- Building a backend-only service (use soundcloud-api-ts directly)
- Need to download or scrape SoundCloud content (this is an API client, not a scraper)

## Installation
npm install soundcloud-api-ts-next

## Quick Setup
1. Create API routes: import { createSoundCloudRoutes } from "soundcloud-api-ts-next/server"
2. Wrap app with <SoundCloudProvider apiPrefix="/api/soundcloud">
3. Use hooks: useTrack, useTrackSearch, useUser, usePlaylist, usePlayer, etc.

## Key Exports (from "soundcloud-api-ts-next")

### Hooks - General

```ts
function useResolve(url: string | undefined): HookResult<any>
```
Resolve a SoundCloud URL (e.g. `https://soundcloud.com/artist/track`) to a track, user, or playlist object.

### Hooks - Tracks

```ts
function useTrack(trackId: string | number | undefined): HookResult<SoundCloudTrack>
```
Fetch a single track by ID.

```ts
function useTrackSearch(query: string, options?: { limit?: number }): HookResult<SoundCloudTrack[]>
```
Search tracks by query string. Optional limit parameter.

```ts
function useTrackComments(trackId: string | number | undefined): HookResult<SoundCloudComment[]>
```
Fetch comments on a track.

```ts
function useTrackLikes(trackId: string | number | undefined): HookResult<SoundCloudUser[]>
```
Fetch users who liked a track.

```ts
function useRelatedTracks(trackId: string | number | undefined): HookResult<SoundCloudTrack[]>
```
Fetch tracks related to the given track.

```ts
function usePlayer(trackId: string | number | undefined): PlayerState
```
Audio player hook. Returns:
```ts
interface PlayerState {
  playing: boolean;
  progress: number;   // current position in seconds
  duration: number;    // total duration in seconds
  play: () => void;
  pause: () => void;
  toggle: () => void;
  seek: (time: number) => void;
}
```

### Hooks - Users

```ts
function useUser(userId: string | number | undefined): HookResult<SoundCloudUser>
```
Fetch a single user by ID.

```ts
function useUserSearch(query: string): HookResult<SoundCloudUser[]>
```
Search users by query string.

```ts
function useUserTracks(userId: string | number | undefined): HookResult<SoundCloudTrack[]>
```
Fetch a user's tracks.

```ts
function useUserPlaylists(userId: string | number | undefined): HookResult<SoundCloudPlaylist[]>
```
Fetch a user's playlists.

```ts
function useUserLikes(userId: string | number | undefined): HookResult<SoundCloudTrack[]>
```
Fetch a user's liked tracks.

```ts
function useUserFollowers(userId: string | number | undefined): HookResult<SoundCloudUser[]>
```
Fetch a user's followers.

```ts
function useUserFollowings(userId: string | number | undefined): HookResult<SoundCloudUser[]>
```
Fetch a user's followings.

### Hooks - Playlists

```ts
function usePlaylist(playlistId: string | number | undefined): HookResult<SoundCloudPlaylist>
```
Fetch a single playlist by ID.

```ts
function usePlaylistSearch(query: string): HookResult<SoundCloudPlaylist[]>
```
Search playlists by query string.

```ts
function usePlaylistTracks(playlistId: string | number | undefined): HookResult<SoundCloudTrack[]>
```
Fetch tracks in a playlist.

### Hooks - Infinite Scroll

All infinite hooks return:
```ts
interface InfiniteResult<T> {
  data: T[];
  loading: boolean;
  error: Error | null;
  hasMore: boolean;
  loadMore: () => void;
  reset: () => void;
}
```

```ts
function useInfiniteTrackSearch(query: string, options?: { limit?: number }): InfiniteResult<SoundCloudTrack>
function useInfiniteUserSearch(query: string, options?: { limit?: number }): InfiniteResult<SoundCloudUser>
function useInfinitePlaylistSearch(query: string, options?: { limit?: number }): InfiniteResult<SoundCloudPlaylist>
function useInfiniteUserTracks(userId: string | number | null): InfiniteResult<SoundCloudTrack>
function useInfiniteUserPlaylists(userId: string | number | null): InfiniteResult<SoundCloudPlaylist>
function useInfiniteUserLikes(userId: string | number | null): InfiniteResult<SoundCloudTrack>
function useInfiniteUserFollowers(userId: string | number | null): InfiniteResult<SoundCloudUser>
function useInfiniteUserFollowings(userId: string | number | null): InfiniteResult<SoundCloudUser>
function useInfiniteTrackComments(trackId: string | number | null): InfiniteResult<SoundCloudComment>
function useInfinitePlaylistTracks(playlistId: string | number | null): InfiniteResult<SoundCloudTrack>
```

### Hooks - Authentication

```ts
function useSCAuth(): {
  user: SoundCloudUser | null;
  isAuthenticated: boolean;
  loading: boolean;
  login: () => void;
  logout: () => void;
  handleCallback: (code: string, state: string) => Promise<SoundCloudToken>;
}
```
Full OAuth 2.1 with PKCE. Redirects to SoundCloud for login, exchanges code for tokens.

```ts
function useMe(): HookResult<SoundCloudUser>
```
Current authenticated user profile.

```ts
function useMeTracks(): HookResult<SoundCloudTrack[]>
```
Current user's tracks.

```ts
function useMeLikes(): HookResult<SoundCloudTrack[]>
```
Current user's liked tracks.

```ts
function useMePlaylists(): HookResult<SoundCloudPlaylist[]>
```
Current user's playlists.

```ts
function useMeFollowings(): HookResult<SoundCloudUser[]>
```
Users the current user follows.

```ts
function useMeFollowers(): HookResult<SoundCloudUser[]>
```
Current user's followers.

### Hooks - Actions (authenticated)

```ts
function useLike(): {
  likeTrack: (trackId: string | number) => Promise<void>;
  unlikeTrack: (trackId: string | number) => Promise<void>;
  loading: boolean;
  error: Error | null;
}
```
Like or unlike a track. Requires authentication.

```ts
function useFollow(): {
  follow: (userId: string | number) => Promise<void>;
  unfollow: (userId: string | number) => Promise<void>;
  loading: boolean;
  error: Error | null;
}
```
Follow or unfollow a user. Requires authentication.

```ts
function useRepost(): {
  repostTrack: (trackId: string | number) => Promise<void>;
  unrepostTrack: (trackId: string | number) => Promise<void>;
  loading: boolean;
  error: Error | null;
}
```
Repost or unrepost a track. Requires authentication.

### Provider

```tsx
<SoundCloudProvider apiPrefix="/api/soundcloud">
  {children}
</SoundCloudProvider>
```
Wraps app, configures API route prefix, manages auth state.

## Key Exports (from "soundcloud-api-ts-next/server")

```ts
function createSoundCloudRoutes(config: {
  clientId: string;
  clientSecret: string;
  redirectUri?: string;
  getToken?: () => Promise<string>;  // custom token provider (e.g. Redis, database)
  onRouteComplete?: (telemetry: SCRouteTelemetry) => void;  // route-level telemetry
  onRequest?: (telemetry: SCRequestTelemetry) => void;      // per-SC-API-call telemetry
}): SoundCloudRoutes
```

Returns an object with:
- `.handler()` — App Router catch-all handler (assign to GET, POST, DELETE)
- `.pagesHandler()` — Pages Router catch-all handler
- `.resolveUrl(url)` — resolve a SoundCloud URL to an API resource
- `.searchTracks(q)`, `.getTrack(id)`, `.getUser(id)`, etc. — individual server-side methods

When `getToken` is provided, it replaces the built-in client credentials flow for all public routes. Auth routes (`/me/*`, actions) still use the `Authorization: Bearer` header from the request.

## SCAuthManager — Programmatic OAuth 2.1 + PKCE

For apps that need custom server-side logic after token exchange (NextAuth JWT minting, database user creation, account linking). The HTTP routes (`/auth/login`, `/auth/callback`) return tokens as JSON and are sufficient for simple flows; use `SCAuthManager` when you need to run code between "got tokens" and "user is logged in".

```ts
import { createSCAuthManager } from "soundcloud-api-ts-next/server";

// Create once at module level — the in-memory PKCE store is shared across requests
const scAuth = createSCAuthManager({
  clientId: string,
  clientSecret: string,
  redirectUri: string,  // required (unlike createSoundCloudRoutes where it's optional)
});

// Step 1: initiate OAuth
const { url, state } = await scAuth.initLogin();
// url: full SoundCloud authorize URL with PKCE params
// state: random CSRF token — persist in a short-lived httpOnly cookie
// verifier: stored server-side in the SCAuthManager instance (in-memory)

// Step 2: handle callback (after SC redirects back)
const tokens = await scAuth.exchangeCode(code, state);
// Verifies state, looks up PKCE verifier, exchanges code → tokens (one-time use)
// Returns: SoundCloudToken { access_token, refresh_token, expires_in, ... }

// Refresh an expired token
const newTokens = await scAuth.refreshToken(refreshToken);

// Observability
scAuth.pendingLogins; // number of active (non-expired) PKCE entries
```

```ts
interface SCAuthManagerConfig {
  clientId: string;
  clientSecret: string;
  redirectUri: string;
}

interface SCLoginResult {
  url: string;   // SoundCloud authorize URL to redirect the user to
  state: string; // CSRF token — persist securely, verify in callback
}
```

## Common Types

```ts
interface HookResult<T> {
  data: T | null;
  loading: boolean;
  error: Error | null;
}

interface InfiniteResult<T> {
  data: T[];
  loading: boolean;
  error: Error | null;
  hasMore: boolean;
  loadMore: () => void;
  reset: () => void;
}

interface PlayerState {
  playing: boolean;
  progress: number;
  duration: number;
  play: () => void;
  pause: () => void;
  toggle: () => void;
  seek: (time: number) => void;
}

interface SCRouteTelemetry {
  route: string;
  method: string;
  durationMs: number;
  status: number;
  error?: string;
}

interface SoundCloudRoutesConfig {
  clientId: string;
  clientSecret: string;
  redirectUri?: string;
  getToken?: () => Promise<string>;
  onRouteComplete?: (telemetry: SCRouteTelemetry) => void;
  onRequest?: (telemetry: SCRequestTelemetry) => void;
  // soundcloud-api-ts v1.13.0+ options (forwarded to SoundCloudClient)
  fetch?: typeof globalThis.fetch;          // custom fetch for Workers/Bun/Deno
  AbortController?: typeof globalThis.AbortController;
  dedupe?: boolean;                          // default true — dedupes concurrent GETs
  cache?: SoundCloudCache;                   // plug in any cache backend
  cacheTtlMs?: number;                       // default 60000ms
  onRetry?: (info: RetryInfo) => void;       // fires on every retry attempt
}

// From soundcloud-api-ts v1.13.0 — available via import from 'soundcloud-api-ts'
interface SoundCloudCache {
  get<T = unknown>(key: string): Promise<T | undefined> | T | undefined;
  set<T = unknown>(key: string, value: T, options: { ttlMs: number }): Promise<void> | void;
  delete(key: string): Promise<void> | void;
}

interface RetryInfo {
  attempt: number;
  delayMs: number;
  reason: string;
  status?: number;
  url: string;
}

// New endpoints in v1.13.0 (available via routes and directly via soundcloud-api-ts)
// sc.tracks.getTracks(ids: (string|number)[]) → SoundCloudTrack[]
// sc.me.getConnections() → SoundCloudConnection[]
// sc.raw.get(path, params?) → RawResponse<unknown>  (escape hatch for any endpoint)

interface SoundCloudToken {
  access_token: string;
  refresh_token: string;
  expires_in: number;
  token_type: string;
  scope: string;
}

interface SCAuthManagerConfig {
  clientId: string;
  clientSecret: string;
  redirectUri: string;
}

interface SCLoginResult {
  url: string;   // SoundCloud authorize URL — redirect user here
  state: string; // CSRF token — persist in httpOnly cookie, verify in callback
}
```

## TypeScript types (re-exported from soundcloud-api-ts)
SoundCloudTrack, SoundCloudUser, SoundCloudPlaylist, SoundCloudComment, SoundCloudStreams, SoundCloudToken, SoundCloudPaginatedResponse, SoundCloudMe, SoundCloudWebProfile, SoundCloudActivity, SoundCloudActivitiesResponse

## Related packages
- soundcloud-api-ts — TypeScript-first SoundCloud API client (dependency, v1.13.0+)

## Links
- npm: https://www.npmjs.com/package/soundcloud-api-ts-next
- GitHub: https://github.com/twin-paws/soundcloud-api-ts-next
- API Docs: https://twin-paws.github.io/soundcloud-api-ts-next/
- API client: https://github.com/twin-paws/soundcloud-api-ts
